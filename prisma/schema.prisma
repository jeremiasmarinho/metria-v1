generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Agency {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users   User[]
  clients Client[]

  @@map("agencies")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      UserRole @default(ANALYST)
  agencyId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agency Agency @relation(fields: [agencyId], references: [id])

  @@map("users")
}

enum UserRole {
  ADMIN
  ANALYST
}

model Client {
  id        String   @id @default(cuid())
  name      String
  slug      String
  active    Boolean  @default(true)
  phone     String?
  email     String?
  agencyId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // JSONB: tokens OAuth criptografados (AES-256-GCM)
  // Formato: { google: { accessToken, refreshToken, expiresAt }, meta: { ... } }
  integrations Json @default("{}")

  // JSONB: preferências de relatório do cliente
  // Formato: { logo?: string, primaryColor?: string, sections?: string[] }
  reportConfig Json @default("{}")

  agency  Agency   @relation(fields: [agencyId], references: [id])
  metrics Metric[]
  reports Report[]

  @@unique([agencyId, slug])
  @@map("clients")
}

model Metric {
  id        String       @id @default(cuid())
  clientId  String
  agencyId  String
  source    MetricSource
  period    DateTime // Primeiro dia do mês de referência
  data      Json // Dados brutos da API
  fetchedAt DateTime     @default(now())

  client Client @relation(fields: [clientId], references: [id])

  // Idempotência: impede duplicação de métricas
  @@unique([clientId, source, period])
  @@index([agencyId])
  @@map("metrics")
}

enum MetricSource {
  GOOGLE_ANALYTICS
  GOOGLE_SEARCH_CONSOLE
  META_ADS
}

model Report {
  id           String       @id @default(cuid())
  clientId     String
  agencyId     String
  period       DateTime // Mês de referência
  status       ReportStatus @default(PENDING)
  pdfUrl       String? // URL no R2 (com expiração)
  aiAnalysis   String? // Texto gerado pela OpenAI
  errorMessage String? // Último erro (se houver)
  sentAt       DateTime? // Quando foi enviado ao cliente
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  client Client @relation(fields: [clientId], references: [id])

  @@unique([clientId, period])
  @@index([agencyId])
  @@index([status])
  @@map("reports")
}

enum ReportStatus {
  PENDING
  INGESTING
  PROCESSING
  ANALYZING
  COMPILING
  STORING
  DELIVERING
  COMPLETED
  FAILED
  PARTIAL
}
